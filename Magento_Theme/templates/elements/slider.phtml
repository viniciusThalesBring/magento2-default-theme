<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes 2020-present. All rights reserved.
 * This product is licensed per Magento install
 * See https://hyva.io/license
 */

declare(strict_types=1);

use Magento\Framework\View\Element\Template;

/** @var Template $block */
$uniqueId = '_' . uniqid();
$query = $block->getGraphqlQuery();
/**
 * Can be a custom filter, like  "color: { in: [\"yellow\",\"orange\"] },"
 * @var string $productFilters
 */
$productFilters = $block->getProductFilters();
$categoryIds = $block->getCategoryIds();
$priceFrom = $block->getPriceFrom();
$priceTo = $block->getPriceTo();
$pageSize = $block->getPageSize() ?: '8';
$sortAttribute = $block->getSortAttribute() ?: 'position';
$sortDirection = $block->getSortDirection() ?: 'ASC';
$title = $block->getTitle();
$type = $block->getType() ?: "";

$linkedProduct = (in_array($type, ['related', 'crosssell', 'upsell']));

if ($linkedProduct) {
    if ($product = $block->getProduct()) {
        $productSkus = $block->getProduct()->getSku();
    } else {
        $productSkus = '';
    }
} else {
    $productSkus = $block->getProductSkus();
}

$productSkuFilter = $productSkus ? sprintf("sku: { in: [\"%s\"] },", join("\",\"", explode(',',$productSkus))) : "";
$categoryFilter = $categoryIds ? sprintf("category_id: { in: [\"%s\"] }", join("\",\"", explode(',',$categoryIds))) : "";
$priceFilter = $priceFrom || $priceTo ? "price: { from: \"$priceFrom\", to: \"$priceTo\" }," : "";

$productAttributes = "
      sku
      id
      name
      small_image {
        label
        url
      }
      url_key
      url_suffix
      price_range {
        minimum_price {
          regular_price {
            value
            currency
          }
          final_price {
            value
            currency
          }
        }
      }";

$items = $linkedProduct ?
    "{$type}_products {
        $productAttributes
    }" :
    $productAttributes;

$graphqlQuery = $query ?: "
{
  products(
    filter: {
      $productFilters
      $productSkuFilter
      $categoryFilter
      $priceFilter
      }
    pageSize: {$pageSize},
    sort: {{$sortAttribute}: {$sortDirection}}
    ) {
    items {
        $items
    }
  }
}";
?>
<script>
    function initSliderComponent<?= $uniqueId ?>() {
        return {
            active: 0,
            products: [],
            loading: true,
            minHeight: function minHeight() {
                return 'min-height: ' + ((this.loading && '491px') || 0);
            },
            query: <?= /** @noEscape */ json_encode($graphqlQuery) ?>,
            getProducts: function getProducts($nextTick) {
                var $this = this;
                fetch('<?= $block->escapeUrl($block->getBaseUrl()) ?>graphql?query=' + encodeURIComponent(
                    this.query
                ), {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json'},
                })
                    .then(function (response) {
                        return response.json()
                    })
                    .then(
                        function (data) {
                            <?php if ($linkedProduct): ?>
                            return $this.products = (
                                data &&
                                data.data &&
                                data.data.products &&
                                data.data.products.items &&
                                data.data.products.items[0] &&
                                data.data.products.items[0]['<?= $block->escapeHtml($type) ?>_products']
                            ) || [];
                            <?php else: ?>
                            return $this.products = (
                                data &&
                                data.data &&
                                data.data.products &&
                                data.data.products.items
                            ) || [];
                            <?php endif; ?>
                        }
                    ).then(function () {
                    $this.loading = false
                    $nextTick(function() {
                        $this.calcPageSize();
                    });
                });
            },
            addToWishlist: function addToWishlist(productId){
                var formKey = document.querySelector('input[name=form_key]').value;
                var postUrl = BASE_URL+"wishlist/index/add/";
                fetch(postUrl, {
                    "headers": {
                        "content-type": "application/x-www-form-urlencoded; charset=UTF-8",
                    },
                    "body": "form_key="+ formKey + "&product="+productId+"&uenc="+btoa(window.location.href),
                    "method": "POST",
                    "mode": "cors",
                    "credentials": "include"
                }).then(function (response) {
                    if (response.redirected) {
                        window.location.href = response.url;
                        return;
                    } else if (response.ok) {
                        return response.json();
                    } else {
                        typeof window.dispatchMessages !== "undefined" && window.dispatchMessages(
                            [{
                                type: "warning",
                                text: "<?= $block->escapeHtml(__('Could not add item to wishlist.')) ?>"
                            }], 5000
                        );
                    }
                }).then(function (response) {
                    if(!response) { return }
                    typeof window.dispatchMessages !== "undefined" && window.dispatchMessages(
                        [{
                            type: (response.success) ? "success" : "error",
                            text: (response.success)
                                ? "<?= $block->escapeHtml(__("%1 has been added to your Wish List.", __("Product"))) ?>"
                                : response.error_message
                        }], 5000
                    );
                    var reloadCustomerDataEvent = new CustomEvent("reload-customer-section-data");
                    window.dispatchEvent(reloadCustomerDataEvent);
                }).catch(function (error) {
                    typeof window.dispatchMessages !== "undefined" && window.dispatchMessages(
                        [{
                            type: "error",
                            text: error
                        }], 5000
                    );
                });
            },
            getSlider: function getSlider() {
                return this.$el.querySelector('.js_slides');
            },
            pageSize: 1,
            pageFillers: 0,
            calcPageSize: function calcPageSize() {
                var slider = this.getSlider();
                if (slider) {
                    this.pageSize = Math.round(slider.clientWidth / slider.querySelector('.js_slide').clientWidth);
                    this.pageFillers = (this.pageSize * Math.ceil(this.products.length / this.pageSize)) - this.products.length;
                }
            },
            calcActive: function calcActive(event) {
                var slider = this.getSlider();
                this.active = Math.ceil(
                    Math.round(
                        slider.scrollLeft / (slider.scrollWidth / this.products.length)
                    ) / this.pageSize
                ) * this.pageSize;
            }
        }
    }

</script>
<section class="text-gray-700 body-font my-12"
         x-data="initSliderComponent<?= $uniqueId?>()"
         x-init="getProducts($nextTick);"
         :style="minHeight()"
         @resize.window.debounce="calcPageSize(); $nextTick( function() { calcActive() })"
>
    <template x-if="products && products.length">
        <div class="relative container px-5">
            <?php if ($title): ?>
                <div class="container mx-auto flex pt-6 pb-3 mb-6 md:flex-row flex-col items-center border-b-2 border-gray-300">
                    <h3 class="text-gray-900 text-2xl title-font font-medium">
                        <?= $block->escapeHtml($title); ?>
                    </h3>
                </div>
            <?php endif; ?>
            <div class="w-full relative overflow-x-hidden">
                <div class="js_slides w-full relative flex flex-no-wrap snap overflow-auto relative flex-no-wrap flex transition-all"
                     @scroll.debounce="calcActive"
                >
                    <template x-for="product in products">
                        <div class="js_slide w-full md:w-1/2 lg:w-1/3 xl:w-1/4 flex-none py-1">
                            <div class="card card-interactive mx-1">
                                <a :href="'<?= $block->getBaseUrl() ?>' + product.url_key + product.url_suffix"
                                   class="relative product photo product-item-photo flex items-center bg-white"
                                   style="padding-top:100%"
                                   tabindex="-1">
                                    <span class="absolute h-full w-full align-center top-0 left-0 flex content-center flex-wrap p-2 overflow-hidden hover:shadow-sm">
                                        <img class="w-full h-auto self-center"
                                         :src="product.small_image.url"
                                         :alt="product.small_image.label"
                                         loading="lazy"
                                         width="500"
                                         height="500"
                                    />
                                    </span>
                                </a>

                                <p class="pt-3 flex items-center justify-center text-primary px-1">
                                    <a class="product-item-link truncate"
                                        :href="'<?= $block->getBaseUrl() ?>' + product.url_key + product.url_suffix"
                                       >
                                        <span x-text="product.name"></span>
                                    </a>
                                </p>
                                <p class="pt-1 text-gray-900 text-center text-lg"
                                   x-text="new Intl.NumberFormat(document.documentElement.lang, { style: 'currency', currency: product.price_range.minimum_price.final_price.currency }).format(product.price_range.minimum_price.final_price.value)"></p>
                                <p class="p-3 flex flex-wrap inline">
                                    <a class="w-auto mr-auto btn btn-primary justify-center"
                                       :href="'<?= $block->getBaseUrl() ?>' + product.url_key + product.url_suffix">
                                        <svg class="h-6 w-6 border-current inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                                        </svg>
                                        <span class="inline">Add to cart</span>
                                    </a>
                                    <button
                                        @click.prevent="addToWishlist(product.id)"
                                        class="rounded-full w-10 h-10 bg-gray-200 p-0 border-0 inline-flex items-center justify-center text-gray-500 hover:text-red-600 ml-auto">
                                        <svg fill="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-5 h-5"
                                             viewBox="0 0 24 24">
                                            <path
                                                d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"></path>
                                        </svg>
                                    </button>
                                </p>
                            </div>
                        </div>
                    </template>
                    <div :class="{ 'js_dummy_slide w-full md:w-1/2 lg:w-1/3 xl:w-1/4 flex-none py-1' : pageFillers > 0 }"></div>
                    <div :class="{ 'js_dummy_slide w-full md:w-1/2 lg:w-1/3 xl:w-1/4 flex-none py-1' : pageFillers > 1 }"></div>
                    <div :class="{ 'js_dummy_slide w-full md:w-1/2 lg:w-1/3 xl:w-1/4 flex-none py-1' : pageFillers > 2 }"></div>
                </div>
            </div>
            <template x-if="products.length && products.length > pageSize">
                <div class="p-4 flex items-center justify-center flex-1" x-cloak>
                    <button
                        class="w-8 h-8 outline-none focus:outline-none rounded-full mx-4 text-black"
                        :class="{ 'invisible' : active === 0 }"
                        x-on:click="getSlider().scrollLeft = (getSlider().scrollWidth / products.length) * (active-pageSize)">
                        <svg viewBox="0 0 1024 1024"><path class="path1" d="M716.8 1024c6.552 0 13.102-2.499 18.101-7.499 9.998-9.997 9.998-26.206 0-36.203l-442.698-442.698 442.698-442.699c9.998-9.997 9.998-26.206 0-36.203s-26.206-9.998-36.203 0l-460.8 460.8c-9.998 9.997-9.998 26.206 0 36.203l460.8 460.8c5 5 11.55 7.499 18.102 7.499z"></path></svg>
                    </button>
                    <template x-for="(product,index) in products" :key="index">
                        <button class="bg-black w-3 h-3 block mx-1 bg-opacity-25 shadow rounded-full" :alt="index"
                                :class="{'bg-opacity-100': active === index, 'hidden': (pageSize !== 1 && !!(index % pageSize)) }"
                                x-on:click="getSlider().scrollLeft = (getSlider().scrollWidth / products.length) * index"></button>
                    </template>
                    <button
                        class="w-8 h-8 outline-none focus:outline-none rounded-full mx-4 text-black"
                        :class="{  'invisible' : active === products.length-pageSize }"
                        x-on:click="getSlider().scrollLeft = (getSlider().scrollWidth / products.length) * (active+pageSize)">
                        <svg id="lnr-chevron-right" viewBox="0 0 1024 1024"><path class="path1" d="M256 1024c-6.552 0-13.102-2.499-18.101-7.499-9.998-9.997-9.998-26.206 0-36.203l442.698-442.698-442.698-442.699c-9.998-9.997-9.998-26.206 0-36.203s26.206-9.998 36.203 0l460.8 460.8c9.998 9.997 9.998 26.206 0 36.203l-460.8 460.8c-5 5-11.55 7.499-18.102 7.499z"></path></svg>
                    </button>
                </div>
            </template>
        </div>
    </template>
</section>
